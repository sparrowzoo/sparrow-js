"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3189],{45753:function(e,t,r){r.d(t,{Z:function(){return i}});var n=r(2265),s=r(99479);function i(){let[e,t]=(0,n.useState)();return(0,n.useEffect)(()=>(t(s.Z.getCrosStorage()),()=>{null==e||e.destroy()}),[]),e}},99479:function(e,t,r){r.d(t,{Z:function(){return i}});var n=r(23531),s=r(95189);class i{randomUUID(){let e="";for(let t=0;t<36;t++)[8,13,18,23].includes(t)?e+="-":e+="0123456789abcdef"[Math.floor(16*Math.random())];return e}static getCurrentStorage(){return new i(!1)}static getCrosStorage(){return new i}set(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:s.B1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.Z.AUTOMATIC;return(r=this.getStorageType(r),this.cros)?this.request({requestId:this.randomUUID(),command:n.w.SET,storage:r,key:t,value:e}):((r===n.Z.LOCAL?localStorage:sessionStorage).setItem(t,e),Promise.resolve(e))}get(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.B1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Z.AUTOMATIC;return(t=this.getStorageType(t),this.cros)?this.request({requestId:this.randomUUID(),command:n.w.GET,storage:t,key:e}):Promise.resolve(("local"===t?localStorage:sessionStorage).getItem(e))}remove(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.B1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Z.AUTOMATIC;if(t=this.getStorageType(t),!this.cros){let r=t===n.Z.LOCAL?localStorage:sessionStorage,s=r.getItem(e);return r.removeItem(e),Promise.resolve(s)}return this.request({requestId:this.randomUUID(),command:n.w.REMOVE,storage:t,key:e})}destroy(){document.body.removeChild(this.iframe)}async getToken(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.Z.AUTOMATIC,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=await this.get(s.B1,e);if(r)return r;if(t){let e=await t();return await this.setToken(e),e}return null}setToken(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Z.AUTOMATIC;return this.set(e,s.B1,t)}removeToken(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n.Z.AUTOMATIC;return this.remove(s.B1,e)}getStorageType(e){return e===n.Z.AUTOMATIC&&(e="SESSION"===s.oT?n.Z.SESSION:n.Z.LOCAL),e}request(e){return new Promise((t,r)=>{let n=s=>{var i;!this.iframeOrigin||(null===this||void 0===this?void 0:null===(i=this.iframeOrigin)||void 0===i?void 0:i.indexOf(s.origin))<0||s.data.requestId!==e.requestId||(window.removeEventListener("message",n),s.data.error?r(Error(s.data.error)):t(s.data.value))};window.addEventListener("message",n);let s=()=>{if(console.log("send request",this.loaded),!this.loaded){setTimeout(s,1e3);return}try{var t;null===(t=this.iframe.contentWindow)||void 0===t||t.postMessage(e,this.iframeOrigin)}catch(e){setTimeout(s,1e3)}};s()})}constructor(e=null){if(this.cros=!1,this.loaded=!1,!1===e||(this.cros=!!s.Tb,!1==this.cros))return;let t=document.createElement("iframe");t.src=s.Tb,t.style.display="none",this.iframe=t,console.log("append iframe "+s.Tb),t.addEventListener("DOMContentLoaded",()=>{console.log("iframe DOMContentLoaded"),this.loaded=!0}),t.addEventListener("load",()=>{console.log("iframe loaded"),this.loaded=!0}),document.body.appendChild(t),this.iframeOrigin=s.Tb}}},95189:function(e,t,r){r.d(t,{B1:function(){return a},Ee:function(){return s},Tb:function(){return u},Y4:function(){return c},Yo:function(){return d},ZE:function(){return l},lg:function(){return i},oT:function(){return o}});var n=r(20357);let s="user_info",i="http://www.sparrowzoo.com",o="SESSION",a="sparrow-token",c="http://www.sparrowzoo.com/react",u="http://passport.sparrowzoo.com/cros-storage";n.env.NEXT_PUBLIC_CAPTCHA_URL;let l="http://passport.sparrowzoo.com/sign-in",d="ws://www.sparrowzoo.com/websocket"},28773:function(e,t,r){r.d(t,{Z:function(){return o}});var n=r(95189),s=r(94962),i=r(99479);class o{static async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i.Z.getCurrentStorage(),r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e=n.lg+e;let o=null;t&&(o=await (null==t?void 0:t.getToken().then(e=>e)));let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:o}};return r&&(a.credentials="include"),new Promise((t,r)=>{fetch(e,a).then(async e=>{let n=await e.json();"0"!=n.code?(s.ZP.error(null==n?void 0:n.message),r(n)):t(n)}).catch(e=>{s.ZP.error(e.message),r(e)})})}static async post(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.Z.getCurrentStorage(),o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=n.lg+e;let a=null;r&&(a=await r.getToken().then(e=>e));let c={method:"POST",headers:{"Content-Type":"application/json",Authorization:a},body:t};return o&&(c.credentials="include"),new Promise((t,r)=>{fetch(e,c).then(async e=>{let n=await e.json();"0"!=n.code?(s.ZP.error(null==n?void 0:n.message),r(n)):t(n)}).catch(e=>{s.ZP.error(e.message),r(e)})})}}},32384:function(e,t,r){r.d(t,{Z:function(){return n}});class n{static bytes2ArrayBuffer(e){let t=new Uint8Array(e.length);for(let r=0;r<t.length;r++)t[r]=e[r];return t}static str2Buffer(e){if("undefined"==typeof TextEncoder){let t,r=[];for(let n=0;n<e.length;n++)(t=e.charCodeAt(n))>=65536&&t<=1114111?(r.push(t>>18&7|240),r.push(t>>12&63|128),r.push(t>>6&63|128),r.push(63&t|128)):t>=2048&&t<=65535?(r.push(t>>12&15|224),r.push(t>>6&63|128),r.push(63&t|128)):t>=128&&t<=2047?(r.push(t>>6&31|192),r.push(63&t|128)):r.push(255&t);return n.bytes2ArrayBuffer(r)}return new TextEncoder().encode(e)}static number2Buffer(e){var t=[],r=length=4;do t[--r]=255&e,e>>=8;while(r);return n.bytes2ArrayBuffer(t)}static appendBytes(e,t,r){return e.set(t,r),r+t.byteLength}readString(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s="",i=n?2:1;for(let o=0;o<r;o+=i)s+=String.fromCharCode(n?e.getUint16(t+o,!0):e.getUint8(t+o));return s}}},23531:function(e,t,r){var n,s,i,o;r.d(t,{Z:function(){return s},w:function(){return n}}),(i=n||(n={})).GET="get",i.SET="set",i.REMOVE="remove",(o=s||(s={})).LOCAL="local",o.SESSION="session",o.AUTOMATIC="automatic"},64430:function(e,t,r){r.d(t,{Z:function(){return c}});var n=r(28773),s=r(95189),i=r(21292),o=r(30678);class a{get contacts(){return this._contacts}set contacts(e){this._contacts=e}get quns(){return this._quns}set quns(e){this._quns=e}}class c{static async getVisitorToken(){let e;return await n.Z.get("/chat/v2/get-visitor-token.json").then(async t=>{e=t.data,sessionStorage.setItem(s.B1,t.data)}),e}static async getMessages(e,t){let r=[];return console.log("sessionKey getMessages",e),await n.Z.post("/chat/v2/messages.json",e,t).then(async e=>{let t=e.data;for(let e of(null==t&&(t=[]),t))r.push(o.Z.fromMessage(e))}),r}static async getSessions(e){let t=[];return await n.Z.get("/chat/v2/sessions.json",e).then(async e=>{for(let r of e.data)t.push(i.Z.createSession(r.chatType,r.id))}),t}static async getContacts(e){let t=new a;return await n.Z.get("/contact/contacts.json",e).then(async e=>{e.data&&(t=e.data)}),t}}},17892:function(e,t,r){var n,s,i,o;r.d(t,{Cs:function(){return s},z_:function(){return n}}),(i=n||(n={}))[i.CHAT_1_TO_1=0]="CHAT_1_TO_1",i[i.GROUP=1]="GROUP",(o=s||(s={}))[o.TEXT_MESSAGE=0]="TEXT_MESSAGE",o[o.IMAGE_MESSAGE=1]="IMAGE_MESSAGE";class a{}a.HORIZON_LINE="-"},21292:function(e,t,r){r.d(t,{Z:function(){return i}});var n=r(17892),s=r(8713);class i{get chatType(){return this._chatType}set chatType(e){this._chatType=e}get id(){return this._id}set id(e){this._id=e}static create121Session(e,t){let r=new i;return r.chatType=n.z_.CHAT_1_TO_1,r.id=r.generateKey(e,t),r}static createSession(e,t){let r=new i;return r.chatType=e,r.id=t,r}static parse(e){if(null==e)return null;let t=new i,r=parseInt(e.substring(0,1),10),n=e.substring(1);return t._chatType=r,t.id=n,t}static createGroupSession(e){let t=new i;return t.chatType=n.z_.GROUP,t.id=e,t}isGroup(){return this._chatType==n.z_.GROUP}isOne2One(){return this._chatType==n.z_.CHAT_1_TO_1}getOppositeUser(){let e=s.Z.getCurrentUser();if(null==e||this._chatType===n.z_.GROUP)return null;let t=this.id.substring(0,1),r=this.id.substring(1,2),i=parseInt(this.id.substring(2,4),10),o=this.id.substring(4,4+i),a=this.id.substring(4+i),c=new s.Z(o,parseInt(t,10)),u=new s.Z(a,parseInt(r,10));return c.equals(e)?u:c}toBytes(){return new TextEncoder().encode(this._chatType+this.id)}key(){return this.chatType+this.id}generateKey(e,t){if(null==e||null==t)return"";let r=e,n=t;e.id<=t.id&&(r=t,n=e);let s=(r.id+"").length,i=s+"";return s<10&&(i="0"+s),r.category+""+n.category+i+r.id+n.id}}},8713:function(e,t,r){r.d(t,{Z:function(){return i}});var n=r(32384),s=r(95189);class i{get id(){return this._id}get category(){return this._category}static fromBytes(e,t){let r=e.buffer,n=e.getUint8(t);t+=1;let s=new Uint8Array(r.slice(t,t+n));return t+=n,{chatUser:new i(new TextDecoder().decode(s),e.getUint8(t)),offset:t+1}}static parse(e){let t=e.split("_");return 2!=t.length?null:new i(t[0],Number(t[1]))}static getCurrentUser(){let e=sessionStorage.getItem(s.Ee);if(!e)return null;let t=JSON.parse(e);return new i(t.userId,t.category)}getCategoryName(){return this._category==i.CATEGORY_VISITOR?"访客":this._category==i.CATEGORY_REGISTER?"注册用户":"未知"}key(){return this._id+"_"+this._category}equals(e){return null!=e&&this._id==e.id&&this._category==e.category}toBytes(){let e=n.Z.str2Buffer(this._id+""),t=new Uint8Array([this._category]),r=new Uint8Array(1+e.byteLength+1),s=e.byteLength,i=0;return i=n.Z.appendBytes(r,new Uint8Array([s]),i),i=n.Z.appendBytes(r,e,i),n.Z.appendBytes(r,t,i),r}constructor(e,t){this._id=e,this._category=t}}i.CATEGORY_VISITOR=0,i.CATEGORY_REGISTER=1},30678:function(e,t,r){r.d(t,{Z:function(){return a}});var n,s,i=r(8713),o=r(59846);(n=s||(s={})).left="left",n.right="right";class a{get align(){return this.isSender()?"right":"left"}get messageId(){return this._messageId}get sender(){return this._sender}get receiver(){return this._receiver}get content(){return this._content}get session(){return this._session}set session(e){this._session=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}get sendTime(){let e=new Date(this._clientSendTime);return(0,o.WU)(e,"yyyy-MM-dd")}static fromProtocol(e){let t=new a;return t._sender=e.sender,t._receiver=e.receiver,t._content=e.getStringContent(),t._clientSendTime=e.clientSendTime,t._serverTime=e.serverTime,t._messageId=e.clientSendTime+""+e.sender.id,t}static fromMessage(e){let t=new a;return t._sender=new i.Z(e.sender.id,e.sender.category),t._receiver=new i.Z(e.receiver.id,e.receiver.category),t._content=e.content,t._clientSendTime=e.clientSendTime,t._serverTime=e.serverTime,t._messageId=e.clientSendTime+""+e.sender.id,t}isSender(){let e=i.Z.getCurrentUser();return this.sender.equals(e)}constructor(){}}}}]);