(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3317],{42108:function(e,t,n){Promise.resolve().then(n.bind(n,94962)),Promise.resolve().then(n.bind(n,15245)),Promise.resolve().then(n.bind(n,72159))},15245:function(e,t,n){"use strict";n.d(t,{default:function(){return d}});var s=n(57437),r=n(87138),i=n(49753),o=n(2265),a=n(55504),c=n(30678);class l{reconnectWebSocket(){this.close(),this.stopHeartBeat(),this.stopRetryConnect(),this.reconnectionTimer=setInterval(()=>{if(l.activeStatus===l.INACTIVE_STATUS){console.log("窗口失去焦点，不进行重连");return}if(l.heartStatus===l.ACTIVE_STATUS){console.log("心跳正常，不进行重连");return}if(l.connectionStatus===l.CONNECTING_STATUS){console.log("正在连接中，不进行重连");return}if(l.connectionStatus===l.ACTIVE_STATUS){console.log("连接正常，不进行重连");return}this.connect()},this.reconnectTime)}connect(){try{l.connectionStatus=l.CONNECTING_STATUS,"WebSocket"in window&&(this.initWindowsFocusEvent(),this.ws=new WebSocket(this.url,[this.token]),this.onOpen(),this._onMsg(),this.onClose(),this.onError())}catch(e){l.connectionStatus=l.INACTIVE_STATUS,console.log("链接失败，直接重连",e),this.reconnectWebSocket()}}onOpen(){this.ws.onopen=e=>{console.log("连接成功"+e),this.connectionTimestamp=new Date().getTime(),l.connectionStatus=l.ACTIVE_STATUS,this.startHeartBeat()}}onClose(){this.ws.onclose=e=>{e.wasClean,l.connectionStatus=l.INACTIVE_STATUS,console.log("连接关闭,e.wasClean="+e.wasClean)}}onError(){this.ws.onerror=e=>{console.log("连接出错"),l.connectionStatus=l.INACTIVE_STATUS,this.reconnectWebSocket()}}startHeartBeat(){this.stopRetryConnect(),this.stopHeartBeat(),this.lastHeartTime=new Date().getTime(),this.heartTimer=setInterval(()=>{var e=new Date().getTime()-this.lastHeartTime;if(e>this.heartTimeout){console.log("超时重连 heart diff {}",e),this.stopHeartBeat(),this.reconnectWebSocket();return}try{this.ws.send("PING")}catch(e){console.log("heart beat error:"+e)}},this.heartTime)}stopHeartBeat(){clearTimeout(this.heartTimer),l.heartStatus=l.INACTIVE_STATUS}stopRetryConnect(){clearTimeout(this.reconnectionTimer)}sendMessage(e){this.messageContainer.putMessage(e.chatSession.key(),new c.v(e)),this.ws.send(e.toBytes())}reconnectionCallback(){console.log("重连回调")}close(){if(null==this.ws){console.log("websocket is null");return}this.ws.close()}initWindowsFocusEvent(){window.onfocus=function(){console.log("window.onfocus"),l.activeStatus=l.ACTIVE_STATUS},window.onclick=function(){console.log("window.onclick"),l.activeStatus=l.ACTIVE_STATUS},window.onblur=function(){console.log("window.onblur"),l.activeStatus=l.INACTIVE_STATUS}}_onMsg(){this.ws.onmessage=async e=>{if("string"==typeof e.data){if("PONG"===e.data){this.lastHeartTime=new Date().getTime(),l.heartStatus=l.ACTIVE_STATUS;return}if("OFFLINE"===e.data){this.offlineCallback({offline:!0});return}var t=JSON.parse(e.data);this.userValidCallback(t);return}let n=await e.data.arrayBuffer(),s=a.Z.fromBytes(n),r=new c.v(s);this.messageContainer.putMessage(s.chatSession.key(),r),this.onMsgCallback(s)}}constructor(e,t){this.heartTime=1e3,this.heartTimeout=5e3,this.reconnectTime=1e3,this.lastHeartTime=0,this.url=e,this.token=t}}l.ACTIVE_STATUS="active",l.INACTIVE_STATUS="inactive",l.CONNECTING_STATUS="connecting",l.activeStatus=l.INACTIVE_STATUS,l.heartStatus=l.INACTIVE_STATUS,l.connectionStatus=l.INACTIVE_STATUS;var h=n(25182),u=n(94962),g=n(78411);function d(e){let{children:t}=e,[n,a]=(0,o.useState)();(0,o.useEffect)(()=>((async function(){let e=await (0,h.LP)(!0),t=new l(i.Yo,e);t.userValidCallback=e=>{console.log("userValidCallback",JSON.stringify(e)),"0"==e.code?sessionStorage.setItem(i.Ee,JSON.stringify(e.data)):((0,h.gy)(),u.ZP.error(e.message))},t.connect(),t.onMsgCallback=e=>{},a(t)})(),()=>{null==n||n.close()}),[]);let c=(0,o.useMemo)(()=>({sparrowWebSocket:n}),[n]);return n?(0,s.jsxs)("div",{className:"flex flex-row flex-1 w-full",children:[(0,s.jsxs)("div",{className:"w-[20rem] flex flex-col  gap-4 p-4 border-r border-indigo-500",children:[(0,s.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,s.jsx)(r.default,{href:"".concat(i.Y4,"/chat/friends"),children:"通讯录管理"})}),(0,s.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,s.jsx)(r.default,{href:"".concat(i.Y4,"/chat/sessions/session"),children:"我的会话"})})]}),(0,s.jsx)("div",{className:"flex-1 border-l border-indigo-500",children:(0,s.jsx)(g.D.Provider,{value:c,children:t})})]}):(0,s.jsx)("div",{children:"loading..."})}},72159:function(e,t,n){"use strict";n.d(t,{default:function(){return a}});var s=n(57437),r=n(2265),i=n(88161),o=n(25182);function a(){let[e,t]=(0,r.useState)("");return(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{children:"登录"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("input",{className:"text-red-700",onChange:e=>t(e.target.value),type:"text",placeholder:"用户名"}),(0,s.jsx)("button",{onClick:()=>{console.log(e),console.log("login",e),i.H.post("/chat/v2/login.json",JSON.stringify({id:e,category:1}),!1).then(e=>{(0,o.o4)(e.data),console.log(JSON.stringify(e))})},children:"登录"}),(0,s.jsx)("button",{onClick:()=>{console.log(e),console.log("login",e),i.H.post("/chat/v2/long-login.json",e,!1).then(e=>{(0,o.o4)(e.data),console.log(JSON.stringify(e))})},children:"Long UserId登录"})]})]})}},49753:function(e,t,n){"use strict";n.d(t,{B1:function(){return o},Ee:function(){return s},Y4:function(){return c},Yo:function(){return l},_k:function(){return a},lg:function(){return r},oT:function(){return i}});let s="user_info",r="http://www.sparrowzoo.com",i="SESSION",o="sparrow-token",a="SESSION",c="http://www.sparrowzoo.com/react",l="ws://www.sparrowzoo.com/websocket"},88161:function(e,t,n){"use strict";n.d(t,{H:function(){return o}});var s=n(25182),r=n(49753),i=n(94962);class o{static async get(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];e=r.lg+e;let n=null;return t&&(n=await (0,s.LP)(!1).then(e=>e)),new Promise((t,s)=>{fetch(e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:n}}).then(async e=>{let n=await e.json();"0"!=n.code?(i.ZP.error(null==n?void 0:n.message),s(n)):t(n)}).catch(e=>{i.ZP.error(e.message),s(e)})})}static async post(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2];e=r.lg+e;let o=null;return n&&(o=await (0,s.LP)(!1).then(e=>e)),new Promise((n,s)=>{fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o},body:t}).then(async e=>{let t=await e.json();"0"!=t.code?(i.ZP.error(null==t?void 0:t.message),s(t)):n(t)}).catch(e=>{i.ZP.error(e.message),s(e)})})}}},25182:function(e,t,n){"use strict";n.d(t,{LP:function(){return a},gy:function(){return o},o4:function(){return c}});var s=n(49753),r=n(88161);class i{static async getVisitorToken(){let e;return await r.H.get("/chat/v2/get-visitor-token.json",!1).then(async t=>{e=t.data,sessionStorage.setItem(s.B1,t.data)}),e}static async getMessages(e){let t;return await r.H.post("/chat/v2/messages.json",e).then(async e=>{t=e.data}),t}}function o(){sessionStorage.removeItem(s.B1),localStorage.removeItem(s.B1),sessionStorage.removeItem(s.Ee)}async function a(e){null==e&&(e=!1);let t=sessionStorage.getItem(s.B1);return t||(t=localStorage.getItem(s.B1))?t:e?t=await i.getVisitorToken():""}function c(e){if(s.oT==s._k){sessionStorage.setItem(s.B1,e);return}localStorage.setItem(s.B1,e)}},78411:function(e,t,n){"use strict";n.d(t,{D:function(){return s}});let s=(0,n(2265).createContext)(null)},51447:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});class s{static bytes2ArrayBuffer(e){let t=new Uint8Array(e.length);for(let n=0;n<t.length;n++)t[n]=e[n];return t}static str2Buffer(e){if("undefined"==typeof TextEncoder){let t,n=[];for(let s=0;s<e.length;s++)(t=e.charCodeAt(s))>=65536&&t<=1114111?(n.push(t>>18&7|240),n.push(t>>12&63|128),n.push(t>>6&63|128),n.push(63&t|128)):t>=2048&&t<=65535?(n.push(t>>12&15|224),n.push(t>>6&63|128),n.push(63&t|128)):t>=128&&t<=2047?(n.push(t>>6&31|192),n.push(63&t|128)):n.push(255&t);return s.bytes2ArrayBuffer(n)}return new TextEncoder().encode(e)}static number2Buffer(e){var t=[],n=length=4;do t[--n]=255&e,e>>=8;while(n);return s.bytes2ArrayBuffer(t)}static appendBytes(e,t,n){return e.set(t,n),n+t.byteLength}readString(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r="",i=s?2:1;for(let o=0;o<n;o+=i)r+=String.fromCharCode(s?e.getUint16(t+o,!0):e.getUint8(t+o));return r}}},17892:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});class s{}s.TEXT_MESSAGE=0,s.IMAGE_MESSAGE=1,s.CHAT_TYPE_1_TO_1=0,s.CHAT_TYPE_GROUP=1,s.HORIZON_LINE="-"},21292:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var s=n(17892),r=n(8713);class i{get chatType(){return this._chatType}set chatType(e){this._chatType=e}get id(){return this._id}set id(e){this._id=e}static create121Session(e,t){let n=new i;return n.chatType=s.Z.CHAT_TYPE_1_TO_1,n.id=n.generateKey(e,t),n}static parse(e){if(null==e)return null;let t=new i,n=parseInt(e.substring(0,1),10),s=e.substring(1);return t._chatType=n,t.id=s,t}static createGroupSession(e){let t=new i;return t.chatType=s.Z.CHAT_TYPE_GROUP,t.id=e,t}isGroup(){return this._chatType==s.Z.CHAT_TYPE_GROUP}isOne2One(){return this._chatType==s.Z.CHAT_TYPE_1_TO_1}getOppositeUser(){let e=r.Z.getCurrentUser();if(null==e||this._chatType===s.Z.CHAT_TYPE_GROUP)return null;let t=this.id.substring(0,1),n=this.id.substring(1,2),i=parseInt(this.id.substring(2,4),10),o=this.id.substring(4,4+i),a=this.id.substring(4+i),c=new r.Z(o,parseInt(t,10)),l=new r.Z(a,parseInt(n,10));return c.equals(e)?l:c}toBytes(){return new TextEncoder().encode(this._chatType+this.id)}key(){return this.chatType+this.id}generateKey(e,t){if(null==e||null==t)return"";let n=e,s=t;e.getId()<=t.getId()&&(n=t,s=e);let r=(n.getId()+"").length,i=r+"";return r<10&&(i="0"+r),n.getCategory()+""+s.getCategory()+i+n.getId()+s.getId()}}},8713:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var s=n(51447),r=n(49753);class i{static fromBytes(e,t){let n=e.buffer,s=e.getUint8(t);t+=1;let r=new Uint8Array(n.slice(t,t+s));return t+=s,{chatUser:new i(new TextDecoder().decode(r),e.getUint8(t)),offset:t+1}}static parse(e){let t=e.split("_");return 2!=t.length?null:new i(t[0],Number(t[1]))}static getCurrentUser(){let e=sessionStorage.getItem(r.Ee);if(!e)return null;let t=JSON.parse(e);return new i(t.userId,t.category)}getId(){return this.id}getCategory(){return this.category}getCategoryName(){return this.category==i.CATEGORY_VISITOR?"访客":this.category==i.CATEGORY_REGISTER?"注册用户":"未知"}key(){return this.id+"_"+this.category}equals(e){return null!=e&&this.id==e.getId()&&this.category==e.getCategory()}toBytes(){let e=s.Z.str2Buffer(this.id+""),t=new Uint8Array([this.category]),n=new Uint8Array(1+e.byteLength+1),r=e.byteLength,i=0;return i=s.Z.appendBytes(n,new Uint8Array([r]),i),i=s.Z.appendBytes(n,e,i),s.Z.appendBytes(n,t,i),n}constructor(e,t){this.id=e,this.category=t}}i.CATEGORY_VISITOR=0,i.CATEGORY_REGISTER=1},30678:function(e,t,n){"use strict";n.d(t,{v:function(){return r}});var s=n(59846);class r{get align(){return this._align}get messageId(){return this._messageId}get senderName(){return this._senderName}get senderCategory(){return this._senderCategory}get receiverName(){return this._receiverName}get receiverCategory(){return this._receiverCategory}get content(){return this._content}get sendTime(){return this._sendTime}constructor(e){this._messageId=e.clientSendTime+Math.random(),this._align=e.align(),this._senderName=e.sender.getId(),this._senderCategory=e.sender.getCategoryName(),this._receiverName=e.receiver.getId(),this._receiverCategory=e.receiver.getCategoryName(),this._content=e.getStringContent();let t=new Date(e.clientSendTime);this._sendTime=(0,s.WU)(t,"yyyy-MM-dd")}}},55504:function(e,t,n){"use strict";var s=n(8713),r=n(21292),i=n(51447),o=n(17892);class a{get version(){return this._version}set version(e){this._version=e}get messageType(){return this._messageType}set messageType(e){this._messageType=e}get chatType(){return this._chatType}set chatType(e){this._chatType=e}get sender(){return this._sender}set sender(e){this._sender=e}get receiver(){return this._receiver}set receiver(e){this._receiver=e}get chatSession(){return this._chatSession}set chatSession(e){this._chatSession=e}get content(){return this._content}set content(e){this._content=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}static fromBytes(e){let t=new a,n=new DataView(e),i=0;t.version=n.getUint8(i);let c=n.getUint8(i+1);t.chatType=c;let l=n.getUint8(i+2);t.messageType=l;let h=s.Z.fromBytes(n,i+3);if(t.sender=h.chatUser,i=h.offset,c===o.Z.CHAT_TYPE_1_TO_1){let e=s.Z.fromBytes(n,i),r=e.chatUser;t.receiver=r,i=e.offset}else{let s=n.getUint8(i);i+=1;let o=new Uint8Array(e.slice(i,i+s)).toString();t.chatSession=r.Z.createGroupSession(o)}let u=n.getUint32(i);i+=4,t.content=new Uint8Array(e.slice(i,i+u)),i+=u;let g=new TextDecoder().decode(new Uint8Array(e.slice(i,e.byteLength)));return t.clientSendTime=parseInt(g,10),t}static create121Chat(e,t,n,c){let l=new a,h=s.Z.getCurrentUser();return l.version=1,l.chatType=o.Z.CHAT_TYPE_1_TO_1,l.messageType=e,l.sender=h,l.receiver=t,l.chatSession=r.Z.create121Session(l.sender,t),l.content=i.Z.str2Buffer(n),l.clientSendTime=c,l}toBytes(){return this.chatType===o.Z.CHAT_TYPE_1_TO_1?this.to121Bytes():this.toGroupBytes()}to121Bytes(){let e=this.sender.toBytes(),t=this.receiver.toBytes(),n=i.Z.str2Buffer(this.clientSendTime+""),s=3+e.byteLength+t.byteLength+4+this.content.byteLength+n.byteLength,r=0,o=new Uint8Array(s);return r=i.Z.appendBytes(o,new Uint8Array([this._version,this.chatType,this.messageType]),r),r=i.Z.appendBytes(o,e,r),r=i.Z.appendBytes(o,t,r),r=i.Z.appendBytes(o,i.Z.number2Buffer(this.content.byteLength),r),r=i.Z.appendBytes(o,this.content,r),i.Z.appendBytes(o,n,r),o}toGroupBytes(){let e=0,t=this.sender.toBytes(),n=this.chatSession.toBytes(),s=i.Z.str2Buffer(this.clientSendTime+""),r=new Uint8Array(3+t.byteLength+1+n.byteLength+4+this.content.byteLength+s.byteLength);return e=i.Z.appendBytes(r,new Uint8Array([this._version,this.chatType,this.messageType]),e),e=i.Z.appendBytes(r,t,e),e=i.Z.appendBytes(r,new Uint8Array([n.byteLength]),e),e=i.Z.appendBytes(r,n,e),e=i.Z.appendBytes(r,i.Z.number2Buffer(this.content.byteLength),e),e=i.Z.appendBytes(r,this.content,e),i.Z.appendBytes(r,s,e),r}getStringContent(){return new TextDecoder().decode(this.content)}isSender(){let e=s.Z.getCurrentUser();return this.sender.equals(e)}align(){return this.isSender()?"right":"left"}constructor(){}}t.Z=a}},function(e){e.O(0,[231,9846,1260,2971,7023,1744],function(){return e(e.s=42108)}),_N_E=e.O()}]);