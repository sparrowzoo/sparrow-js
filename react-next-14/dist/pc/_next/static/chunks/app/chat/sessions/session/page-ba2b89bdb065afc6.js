(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8426],{91769:function(e,t,r){Promise.resolve().then(r.bind(r,71409))},16463:function(e,t,r){"use strict";var n=r(71169);r.o(n,"useSearchParams")&&r.d(t,{useSearchParams:function(){return n.useSearchParams}})},71409:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return y}});var n=r(57437),s=r(2265),i=r(16463);function a(e){let t="left"===e.align?"items-start":"items-end";return(0,n.jsxs)("div",{className:"flex flex-col ".concat(t),children:[(0,n.jsxs)("div",{className:"flex flex-row  p-4 bg-gray-100 rounded-lg",children:[(0,n.jsx)("img",{className:" w-8 h-8 rounded-full mr-4",src:e.avatar}),(0,n.jsxs)("strong",{className:"flex-1 text-gray-900",children:["sender: ",e.sender," @",e.timestamp]})]}),(0,n.jsxs)("p",{className:"text-gray-600",children:[e.message,e.img&&(0,n.jsx)("img",{className:"w-64",src:e.img})]})]})}var c=r(55504),o=r(17892),u=r(30678),h=r(49753),l=r(21292),d=r(78411);function g(){let e=(0,i.useSearchParams)(),t=null==e?void 0:e.get("sessionKey"),[r,g]=(0,s.useState)(""),[y,p]=(0,s.useState)([]),f=(0,s.useRef)(null),_=(0,s.useContext)(d.D);function T(){var e;let n;let s=l.Z.parse(t);if(console.log("containerRef",f.current),(null==s?void 0:s.chatType)==o.Z.CHAT_TYPE_1_TO_1){let e=s.getOppositeUser();n=c.Z.create121Chat(o.Z.TEXT_MESSAGE,e,r,new Date().getTime())}e=n,p(t=>[...t,new u.v(e)]),null==_||_.sendMessage(n),g("")}return(0,s.useEffect)(()=>{var e;null===(e=f.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end"})},[y]),null===_?(0,n.jsx)("div",{children:"Loading..."}):(0,n.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,n.jsx)("div",{children:(0,n.jsxs)("h2",{children:["Welcome to: ",t]})}),(0,n.jsxs)("div",{className:"overflow-y-scroll h-[25rem] p-4 border-2 border-red-700",children:[y.map(e=>(0,n.jsx)(a,{avatar:"".concat(h.Y4,"/avatar/").concat(e.senderName,".jpg"),img:void 0,align:e.align,message:e.content,sender:e.senderName,timestamp:e.sendTime},e.messageId)),(0,n.jsx)("div",{className:"h-[0px] h-[0px]",ref:f})]}),(0,n.jsx)("textarea",{value:r,onKeyDown:e=>{"Enter"===e.code&&T()},onChange:e=>g(e.target.value),className:"w-full flex-1"}),(0,n.jsx)("button",{onClick:e=>T(),className:"bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",children:"Send"})]})}function y(){return(0,n.jsx)(s.Suspense,{children:(0,n.jsx)(g,{})})}},49753:function(e,t,r){"use strict";r.d(t,{B1:function(){return a},Ee:function(){return n},Y4:function(){return o},Yo:function(){return u},_k:function(){return c},lg:function(){return s},oT:function(){return i}});let n="user_info",s="http://www.sparrowzoo.com",i="SESSION",a="sparrow-token",c="SESSION",o="http://www.sparrowzoo.com/react",u="ws://www.sparrowzoo.com/websocket"},78411:function(e,t,r){"use strict";r.d(t,{D:function(){return n}});let n=(0,r(2265).createContext)(null)},51447:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});class n{static bytes2ArrayBuffer(e){let t=new Uint8Array(e.length);for(let r=0;r<t.length;r++)t[r]=e[r];return t}static str2Buffer(e){if("undefined"==typeof TextEncoder){let t,r=[];for(let n=0;n<e.length;n++)(t=e.charCodeAt(n))>=65536&&t<=1114111?(r.push(t>>18&7|240),r.push(t>>12&63|128),r.push(t>>6&63|128),r.push(63&t|128)):t>=2048&&t<=65535?(r.push(t>>12&15|224),r.push(t>>6&63|128),r.push(63&t|128)):t>=128&&t<=2047?(r.push(t>>6&31|192),r.push(63&t|128)):r.push(255&t);return n.bytes2ArrayBuffer(r)}return new TextEncoder().encode(e)}static number2Buffer(e){var t=[],r=length=4;do t[--r]=255&e,e>>=8;while(r);return n.bytes2ArrayBuffer(t)}static appendBytes(e,t,r){return e.set(t,r),r+t.byteLength}readString(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s="",i=n?2:1;for(let a=0;a<r;a+=i)s+=String.fromCharCode(n?e.getUint16(t+a,!0):e.getUint8(t+a));return s}}},17892:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});class n{}n.TEXT_MESSAGE=0,n.IMAGE_MESSAGE=1,n.CHAT_TYPE_1_TO_1=0,n.CHAT_TYPE_GROUP=1,n.HORIZON_LINE="-"},21292:function(e,t,r){"use strict";r.d(t,{Z:function(){return i}});var n=r(17892),s=r(8713);class i{get chatType(){return this._chatType}set chatType(e){this._chatType=e}get id(){return this._id}set id(e){this._id=e}static create121Session(e,t){let r=new i;return r.chatType=n.Z.CHAT_TYPE_1_TO_1,r.id=r.generateKey(e,t),r}static parse(e){if(null==e)return null;let t=new i,r=parseInt(e.substring(0,1),10),n=e.substring(1);return t._chatType=r,t.id=n,t}static createGroupSession(e){let t=new i;return t.chatType=n.Z.CHAT_TYPE_GROUP,t.id=e,t}isGroup(){return this._chatType==n.Z.CHAT_TYPE_GROUP}isOne2One(){return this._chatType==n.Z.CHAT_TYPE_1_TO_1}getOppositeUser(){let e=s.Z.getCurrentUser();if(null==e||this._chatType===n.Z.CHAT_TYPE_GROUP)return null;let t=this.id.substring(0,1),r=this.id.substring(1,2),i=parseInt(this.id.substring(2,4),10),a=this.id.substring(4,4+i),c=this.id.substring(4+i),o=new s.Z(a,parseInt(t,10)),u=new s.Z(c,parseInt(r,10));return o.equals(e)?u:o}toBytes(){return new TextEncoder().encode(this._chatType+this.id)}key(){return this.chatType+this.id}generateKey(e,t){if(null==e||null==t)return"";let r=e,n=t;e.getId()<=t.getId()&&(r=t,n=e);let s=(r.getId()+"").length,i=s+"";return s<10&&(i="0"+s),r.getCategory()+""+n.getCategory()+i+r.getId()+n.getId()}}},8713:function(e,t,r){"use strict";r.d(t,{Z:function(){return i}});var n=r(51447),s=r(49753);class i{static fromBytes(e,t){let r=e.buffer,n=e.getUint8(t);t+=1;let s=new Uint8Array(r.slice(t,t+n));return t+=n,{chatUser:new i(new TextDecoder().decode(s),e.getUint8(t)),offset:t+1}}static parse(e){let t=e.split("_");return 2!=t.length?null:new i(t[0],Number(t[1]))}static getCurrentUser(){let e=sessionStorage.getItem(s.Ee);if(!e)return null;let t=JSON.parse(e);return new i(t.userId,t.category)}getId(){return this.id}getCategory(){return this.category}getCategoryName(){return this.category==i.CATEGORY_VISITOR?"访客":this.category==i.CATEGORY_REGISTER?"注册用户":"未知"}key(){return this.id+"_"+this.category}equals(e){return null!=e&&this.id==e.getId()&&this.category==e.getCategory()}toBytes(){let e=n.Z.str2Buffer(this.id+""),t=new Uint8Array([this.category]),r=new Uint8Array(1+e.byteLength+1),s=e.byteLength,i=0;return i=n.Z.appendBytes(r,new Uint8Array([s]),i),i=n.Z.appendBytes(r,e,i),n.Z.appendBytes(r,t,i),r}constructor(e,t){this.id=e,this.category=t}}i.CATEGORY_VISITOR=0,i.CATEGORY_REGISTER=1},30678:function(e,t,r){"use strict";r.d(t,{v:function(){return s}});var n=r(59846);class s{get align(){return this._align}get messageId(){return this._messageId}get senderName(){return this._senderName}get senderCategory(){return this._senderCategory}get receiverName(){return this._receiverName}get receiverCategory(){return this._receiverCategory}get content(){return this._content}get sendTime(){return this._sendTime}constructor(e){this._messageId=e.clientSendTime+Math.random(),this._align=e.align(),this._senderName=e.sender.getId(),this._senderCategory=e.sender.getCategoryName(),this._receiverName=e.receiver.getId(),this._receiverCategory=e.receiver.getCategoryName(),this._content=e.getStringContent();let t=new Date(e.clientSendTime);this._sendTime=(0,n.WU)(t,"yyyy-MM-dd")}}},55504:function(e,t,r){"use strict";var n=r(8713),s=r(21292),i=r(51447),a=r(17892);class c{get version(){return this._version}set version(e){this._version=e}get messageType(){return this._messageType}set messageType(e){this._messageType=e}get chatType(){return this._chatType}set chatType(e){this._chatType=e}get sender(){return this._sender}set sender(e){this._sender=e}get receiver(){return this._receiver}set receiver(e){this._receiver=e}get chatSession(){return this._chatSession}set chatSession(e){this._chatSession=e}get content(){return this._content}set content(e){this._content=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}static fromBytes(e){let t=new c,r=new DataView(e),i=0;t.version=r.getUint8(i);let o=r.getUint8(i+1);t.chatType=o;let u=r.getUint8(i+2);t.messageType=u;let h=n.Z.fromBytes(r,i+3);if(t.sender=h.chatUser,i=h.offset,o===a.Z.CHAT_TYPE_1_TO_1){let e=n.Z.fromBytes(r,i),s=e.chatUser;t.receiver=s,i=e.offset}else{let n=r.getUint8(i);i+=1;let a=new Uint8Array(e.slice(i,i+n)).toString();t.chatSession=s.Z.createGroupSession(a)}let l=r.getUint32(i);i+=4,t.content=new Uint8Array(e.slice(i,i+l)),i+=l;let d=new TextDecoder().decode(new Uint8Array(e.slice(i,e.byteLength)));return t.clientSendTime=parseInt(d,10),t}static create121Chat(e,t,r,o){let u=new c,h=n.Z.getCurrentUser();return u.version=1,u.chatType=a.Z.CHAT_TYPE_1_TO_1,u.messageType=e,u.sender=h,u.receiver=t,u.chatSession=s.Z.create121Session(u.sender,t),u.content=i.Z.str2Buffer(r),u.clientSendTime=o,u}toBytes(){return this.chatType===a.Z.CHAT_TYPE_1_TO_1?this.to121Bytes():this.toGroupBytes()}to121Bytes(){let e=this.sender.toBytes(),t=this.receiver.toBytes(),r=i.Z.str2Buffer(this.clientSendTime+""),n=3+e.byteLength+t.byteLength+4+this.content.byteLength+r.byteLength,s=0,a=new Uint8Array(n);return s=i.Z.appendBytes(a,new Uint8Array([this._version,this.chatType,this.messageType]),s),s=i.Z.appendBytes(a,e,s),s=i.Z.appendBytes(a,t,s),s=i.Z.appendBytes(a,i.Z.number2Buffer(this.content.byteLength),s),s=i.Z.appendBytes(a,this.content,s),i.Z.appendBytes(a,r,s),a}toGroupBytes(){let e=0,t=this.sender.toBytes(),r=this.chatSession.toBytes(),n=i.Z.str2Buffer(this.clientSendTime+""),s=new Uint8Array(3+t.byteLength+1+r.byteLength+4+this.content.byteLength+n.byteLength);return e=i.Z.appendBytes(s,new Uint8Array([this._version,this.chatType,this.messageType]),e),e=i.Z.appendBytes(s,t,e),e=i.Z.appendBytes(s,new Uint8Array([r.byteLength]),e),e=i.Z.appendBytes(s,r,e),e=i.Z.appendBytes(s,i.Z.number2Buffer(this.content.byteLength),e),e=i.Z.appendBytes(s,this.content,e),i.Z.appendBytes(s,n,e),s}getStringContent(){return new TextDecoder().decode(this.content)}isSender(){let e=n.Z.getCurrentUser();return this.sender.equals(e)}align(){return this.isSender()?"right":"left"}constructor(){}}t.Z=c}},function(e){e.O(0,[9846,2971,7023,1744],function(){return e(e.s=91769)}),_N_E=e.O()}]);