(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3317],{37073:function(e,t,s){Promise.resolve().then(s.bind(s,94962)),Promise.resolve().then(s.bind(s,88213))},87138:function(e,t,s){"use strict";s.d(t,{default:function(){return i.a}});var n=s(231),i=s.n(n)},60291:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"RouterContext",{enumerable:!0,get:function(){return n}});let n=s(99920)._(s(2265)).default.createContext(null)},5166:function(e,t,s){"use strict";s.d(t,{Z:function(){return r}});var n=s(57437);s(2265);var i=s(88978),o=s(81841);function r(){return(0,n.jsx)(i.Z,{animation:o.Z,size:56})}},88213:function(e,t,s){"use strict";s.d(t,{default:function(){return y}});var n=s(57437),i=s(87138),o=s(95189),r=s(2265),a=s(78411),c=s(64430),l=s(30678),h=s(8713),u=s(21292),T=s(32384),S=s(17892);class g{get version(){return this._version}set version(e){this._version=e}get messageType(){return this._messageType}set messageType(e){this._messageType=e}get chatType(){return this._chatType}set chatType(e){this._chatType=e}get sender(){return this._sender}set sender(e){this._sender=e}get receiver(){return this._receiver}set receiver(e){this._receiver=e}get chatSession(){return this._chatSession}set chatSession(e){this._chatSession=e}get content(){return this._content}set content(e){this._content=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}static fromBytes(e){let t=new g,s=new DataView(e),n=0;t.version=s.getUint8(n);let i=s.getUint8(n+1);t.chatType=i;let o=s.getUint8(n+2);t.messageType=o;let r=h.Z.fromBytes(s,n+3);if(t.sender=r.chatUser,n=r.offset,i===S.z_.CHAT_1_TO_1){let e=h.Z.fromBytes(s,n),i=e.chatUser;t.receiver=i,n=e.offset,t.chatSession=u.Z.create121Session(t.sender,t.receiver)}else{let i=s.getUint8(n);n+=1;let o=new Uint8Array(e.slice(n,n+i)).toString();t.chatSession=u.Z.createGroupSession(o)}let a=s.getUint32(n);n+=4,t.content=new Uint8Array(e.slice(n,n+a)),n+=a;let c=new TextDecoder().decode(new Uint8Array(e.slice(n,e.byteLength)));return t.clientSendTime=parseInt(c,10),t}static create121Chat(e,t,s,n){let i=new g,o=h.Z.getCurrentUser();return i.version=1,i.chatType=S.z_.CHAT_1_TO_1,i.messageType=e,i.sender=o,i.receiver=t,i.chatSession=u.Z.create121Session(i.sender,t),i.content=T.Z.str2Buffer(s),i.clientSendTime=n,i}toBytes(){return this.chatType===S.z_.CHAT_1_TO_1?this.to121Bytes():this.toGroupBytes()}to121Bytes(){let e=this.sender.toBytes(),t=this.receiver.toBytes(),s=T.Z.str2Buffer(this.clientSendTime+""),n=3+e.byteLength+t.byteLength+4+this.content.byteLength+s.byteLength,i=0,o=new Uint8Array(n);return i=T.Z.appendBytes(o,new Uint8Array([this._version,this.chatType,this.messageType]),i),i=T.Z.appendBytes(o,e,i),i=T.Z.appendBytes(o,t,i),i=T.Z.appendBytes(o,T.Z.number2Buffer(this.content.byteLength),i),i=T.Z.appendBytes(o,this.content,i),T.Z.appendBytes(o,s,i),o}toGroupBytes(){let e=0,t=this.sender.toBytes(),s=this.chatSession.toBytes(),n=T.Z.str2Buffer(this.clientSendTime+""),i=new Uint8Array(3+t.byteLength+1+s.byteLength+4+this.content.byteLength+n.byteLength);return e=T.Z.appendBytes(i,new Uint8Array([this._version,this.chatType,this.messageType]),e),e=T.Z.appendBytes(i,t,e),e=T.Z.appendBytes(i,new Uint8Array([s.byteLength]),e),e=T.Z.appendBytes(i,s,e),e=T.Z.appendBytes(i,T.Z.number2Buffer(this.content.byteLength),e),e=T.Z.appendBytes(i,this.content,e),T.Z.appendBytes(i,n,e),i}getStringContent(){return new TextDecoder().decode(this.content)}constructor(){}}class d{reconnectWebSocket(){this.close(),this.stopHeartBeat(),this.stopRetryConnect(),this.reconnectionTimer=setInterval(()=>{if(d.activeStatus===d.INACTIVE_STATUS){console.log("窗口失去焦点，不进行重连");return}if(d.heartStatus===d.ACTIVE_STATUS){console.log("心跳正常，不进行重连");return}if(d.connectionStatus===d.CONNECTING_STATUS){console.log("正在连接中，不进行重连");return}if(d.connectionStatus===d.ACTIVE_STATUS){console.log("连接正常，不进行重连");return}this.connect()},this.reconnectTime)}connect(){try{d.connectionStatus=d.CONNECTING_STATUS,"WebSocket"in window&&(this.initWindowsFocusEvent(),this.crosStorage.getToken().then(e=>{this.ws=new WebSocket(this.url,[e]),this.onOpen(),this._onMsg(),this.onClose(),this.onError()}))}catch(e){d.connectionStatus=d.INACTIVE_STATUS,console.log("链接失败，直接重连",e),this.reconnectWebSocket()}}onOpen(){this.ws.onopen=e=>{console.log("连接成功"+e),this.connectionTimestamp=new Date().getTime(),d.connectionStatus=d.ACTIVE_STATUS,this.startHeartBeat()}}onClose(){this.ws.onclose=e=>{e.wasClean,d.connectionStatus=d.INACTIVE_STATUS,console.log("连接关闭,e.wasClean="+e.wasClean)}}onError(){this.ws.onerror=e=>{console.log("连接出错"),d.connectionStatus=d.INACTIVE_STATUS,this.reconnectWebSocket()}}startHeartBeat(){this.stopRetryConnect(),this.stopHeartBeat(),this.lastHeartTime=new Date().getTime(),this.heartTimer=setInterval(()=>{var e=new Date().getTime()-this.lastHeartTime;if(e>this.heartTimeout){console.log("超时重连 heart diff {}",e),this.stopHeartBeat(),this.reconnectWebSocket();return}try{if(this.ws.send("PING"),new Date().getTime()-this.lastStatusMonitoredTime>this.monitorTime){let e=this.monitorStatus();e.length>0?this.ws.send("STATUS|"+JSON.stringify(e)):this.ws.send("STATUS")}}catch(e){console.log("heart beat error:"+e)}},this.heartTime)}stopHeartBeat(){clearTimeout(this.heartTimer),d.heartStatus=d.INACTIVE_STATUS}stopRetryConnect(){clearTimeout(this.reconnectionTimer)}increaseTxid(){return this.txid=this.txid+1,this.txid}sendMessage(e){this.increaseTxid(),this.ws.send(e)}reconnectionCallback(){console.log("重连回调")}close(){if(null==this.ws){console.log("websocket is null");return}this.ws.close()}initWindowsFocusEvent(){window.onfocus=function(){console.log("window.onfocus"),d.activeStatus=d.ACTIVE_STATUS},window.onclick=function(){console.log("window.onclick"),d.activeStatus=d.ACTIVE_STATUS},window.onblur=function(){console.log("window.onblur"),d.activeStatus=d.INACTIVE_STATUS}}_onMsg(){this.ws.onmessage=async e=>{if("string"==typeof e.data){if("PONG"===e.data){this.lastHeartTime=new Date().getTime(),d.heartStatus=d.ACTIVE_STATUS;return}if("OFFLINE"===e.data){this.offlineCallback&&this.offlineCallback({offline:!0});return}var t=JSON.parse(e.data);if("STATUS"==t.instruction){let e=t.data;this.monitorStatusCallback&&this.monitorStatusCallback(e),this.lastStatusMonitoredTime=new Date().getTime();return}"AUTH"==t.instruction&&this.userAuthCallback&&this.userAuthCallback(t);return}let s=await e.data.arrayBuffer();this.increaseTxid(),this.onMsgCallback&&this.onMsgCallback(s)}}constructor(e,t){this.txid=0,this.heartTime=1e3,this.heartTimeout=5e3,this.reconnectTime=1e3,this.lastHeartTime=0,this.monitorTime=1e4,this.lastStatusMonitoredTime=0,this.url=e,this.crosStorage=t}}d.ACTIVE_STATUS="active",d.INACTIVE_STATUS="inactive",d.CONNECTING_STATUS="connecting",d.activeStatus=d.INACTIVE_STATUS,d.heartStatus=d.INACTIVE_STATUS,d.connectionStatus=d.INACTIVE_STATUS;var f=s(94962);class p{get webSocket(){return this._webSocket}closeWebSocket(){this._webSocket.close()}putMessage(e){let t=l.Z.fromProtocol(e),s=e.chatSession.key(),n=this.messageMap.get(s);null==n&&(n=[],this.messageMap.set(s,n)),n.push(t)}sendMessage(e,t){var s;let n;let i=u.Z.parse(e);if((null==i?void 0:i.chatType)==S.z_.CHAT_1_TO_1){let e=i.getOppositeUser();n=g.create121Chat(S.Cs.TEXT_MESSAGE,e,t,new Date().getTime())}this.putMessage(n),null===(s=this._webSocket)||void 0===s||s.sendMessage(n.toBytes())}async getMessageList(e){console.log("getMessageList",e);let t=this.messageMap.get(e);return null!=t||(t=await c.Z.getMessages(e,this.crosStorage),this.messageMap.set(e,t)),t}websocketMsgCallback(e){let t=g.fromBytes(e);this.putMessage(t),this.newMessageSignal()}async getChatSessions(){let e=this.chatSessions;return e||await c.Z.getSessions(this.crosStorage).then(t=>{console.log(t.length),e=t,this.chatSessions=e}),e}async getContactGroup(){let e=this.contactGroup;return e||await c.Z.getContacts(this.crosStorage).then(t=>{console.log(t),e=t,this.contactGroup=e}),e}getGroupDetail(e){var t;return null===(t=this.contactGroup)||void 0===t?void 0:t.quns.find(t=>t.qunId===e)}getContactDetail(e){var t;return null===(t=this.contactGroup)||void 0===t?void 0:t.contacts.find(t=>t.userId===e)}constructor(e){this.messageMap=new Map,this.chatSessions=null,this.contactGroup=null,this.newMessageSignal=()=>{},this.crosStorage=e;let t=new d(o.Yo,e);t.connect(),this._webSocket=t,this._webSocket.onMsgCallback=e=>{this.websocketMsgCallback(e)},this._webSocket.offlineCallback=()=>{f.ZP.error("消息已推送，对方已离线....")},this._webSocket.userAuthCallback=e=>{console.log("userValidCallback",JSON.stringify(e)),"0"==e.code?sessionStorage.setItem(o.Ee,JSON.stringify(e.data)):(this.crosStorage.removeToken(),f.ZP.error(e.message),setTimeout(()=>{window.location.href="".concat(o.ZE,"?").concat(window.location.href)},2e3))},this._webSocket.monitorStatus=()=>(console.log("websocket monitor status"),[]),this._webSocket.monitorStatusCallback=e=>{console.log("websocket monitor status callback",JSON.stringify(e))}}}var w=s(45753),m=s(5166);function y(e){let{children:t}=e,[s,c]=(0,r.useState)(),l=(0,w.Z)();return(console.log("渲染ChatLayout"),(0,r.useEffect)(()=>((async function(){if(!l)return;let e=new p(l),t=a.t.create(e);e.newMessageSignal=()=>{c(null==t?void 0:t.newReference())},c(t)})(),()=>{null==l||l.destroy(),null==s||s.closeWebSocket()}),[l]),s)?(console.log("状态变化会重新渲染",s),(0,n.jsxs)("div",{className:"flex flex-row flex-1 w-full",children:[(0,n.jsxs)("div",{className:"w-[20rem] flex flex-col  gap-4 p-4 border-r border-indigo-500",children:[(0,n.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,n.jsx)(i.default,{href:"".concat(o.Y4,"/chat/friends"),children:"通讯录管理"})}),(0,n.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,n.jsx)(i.default,{href:"".concat(o.Y4,"/chat/sessions/session"),children:"我的会话"})})]}),(0,n.jsx)("div",{className:"flex-1 border-l border-indigo-500",children:(0,n.jsx)(a.D.Provider,{value:s,children:t})})]})):(0,n.jsx)(m.Z,{})}},78411:function(e,t,s){"use strict";s.d(t,{D:function(){return o},t:function(){return i}});var n=s(2265);class i{static create(e){return new i(e)}newReference(){return new i(this.messageBroker)}closeWebSocket(){var e;null===(e=this.messageBroker)||void 0===e||e.closeWebSocket()}constructor(e){this.messageBroker=e}}let o=(0,n.createContext)(null)}},function(e){e.O(0,[4705,231,7145,6090,9846,3189,2971,7023,1744],function(){return e(e.s=37073)}),_N_E=e.O()}]);