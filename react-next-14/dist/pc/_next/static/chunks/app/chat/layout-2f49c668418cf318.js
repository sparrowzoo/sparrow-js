(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3317],{84576:function(e,t,s){Promise.resolve().then(s.bind(s,94962)),Promise.resolve().then(s.bind(s,39394))},95189:function(e,t,s){"use strict";s.d(t,{B1:function(){return o},Ee:function(){return n},Y4:function(){return c},Yo:function(){return l},_k:function(){return a},lg:function(){return r},oT:function(){return i}});let n="user_info",r="http://www.sparrowzoo.com",i="SESSION",o="sparrow-token",a="SESSION",c="http://www.sparrowzoo.com/react",l="ws://www.sparrowzoo.com/websocket"},28773:function(e,t,s){"use strict";s.d(t,{Z:function(){return o}});var n=s(31349),r=s(95189),i=s(94962);class o{static async get(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e=r.lg+e;let o=null;t&&(o=await (0,n.LP)().then(e=>e));let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:o}};return s&&(a.credentials="include"),new Promise((t,s)=>{fetch(e,a).then(async e=>{let n=await e.json();"0"!=n.code?(i.ZP.error(null==n?void 0:n.message),s(n)):t(n)}).catch(e=>{i.ZP.error(e.message),s(e)})})}static async post(e,t){let s=!(arguments.length>2)||void 0===arguments[2]||arguments[2],o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=r.lg+e;let a=null;s&&(a=await (0,n.LP)().then(e=>e));let c={method:"POST",headers:{"Content-Type":"application/json",Authorization:a},body:t};return o&&(c.credentials="include"),new Promise((t,s)=>{fetch(e,c).then(async e=>{let n=await e.json();"0"!=n.code?(i.ZP.error(null==n?void 0:n.message),s(n)):t(n)}).catch(e=>{i.ZP.error(e.message),s(e)})})}}},31349:function(e,t,s){"use strict";s.d(t,{LP:function(){return i},gy:function(){return r},o4:function(){return o}});var n=s(95189);function r(){sessionStorage.removeItem(n.B1),localStorage.removeItem(n.B1),sessionStorage.removeItem(n.Ee)}async function i(e){let t=sessionStorage.getItem(n.B1);return t||(t=localStorage.getItem(n.B1))?t:e?t=await e():""}function o(e){if(n.oT==n._k){sessionStorage.setItem(n.B1,e);return}localStorage.setItem(n.B1,e)}},32384:function(e,t,s){"use strict";s.d(t,{Z:function(){return n}});class n{static bytes2ArrayBuffer(e){let t=new Uint8Array(e.length);for(let s=0;s<t.length;s++)t[s]=e[s];return t}static str2Buffer(e){if("undefined"==typeof TextEncoder){let t,s=[];for(let n=0;n<e.length;n++)(t=e.charCodeAt(n))>=65536&&t<=1114111?(s.push(t>>18&7|240),s.push(t>>12&63|128),s.push(t>>6&63|128),s.push(63&t|128)):t>=2048&&t<=65535?(s.push(t>>12&15|224),s.push(t>>6&63|128),s.push(63&t|128)):t>=128&&t<=2047?(s.push(t>>6&31|192),s.push(63&t|128)):s.push(255&t);return n.bytes2ArrayBuffer(s)}return new TextEncoder().encode(e)}static number2Buffer(e){var t=[],s=length=4;do t[--s]=255&e,e>>=8;while(s);return n.bytes2ArrayBuffer(t)}static appendBytes(e,t,s){return e.set(t,s),s+t.byteLength}readString(e,t,s){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r="",i=n?2:1;for(let o=0;o<s;o+=i)r+=String.fromCharCode(n?e.getUint16(t+o,!0):e.getUint8(t+o));return r}}},39394:function(e,t,s){"use strict";s.d(t,{default:function(){return v}});var n=s(57437),r=s(87138),i=s(95189),o=s(2265),a=s(31349),c=s(78411),l=s(28773),h=s(21292),u=s(8713),g=s(59846);class d{get align(){return this.isSender()?"right":"left"}get messageId(){return this._messageId}get sender(){return this._sender}get receiver(){return this._receiver}get content(){return this._content}get session(){return this._session}set session(e){this._session=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}get sendTime(){let e=new Date(this._clientSendTime);return(0,g.WU)(e,"yyyy-MM-dd")}static fromProtocol(e){let t=new d;return t._sender=e.sender,t._receiver=e.receiver,t._content=e.getStringContent(),t._clientSendTime=e.clientSendTime,t._serverTime=e.serverTime,t._messageId=e.clientSendTime+""+e.sender.id,t}static fromMessage(e){let t=new d;return t._sender=new u.Z(e.sender.id,e.sender.category),t._receiver=new u.Z(e.receiver.id,e.receiver.category),t._content=e.content,t._clientSendTime=e.clientSendTime,t._serverTime=e.serverTime,t._messageId=e.clientSendTime+""+e.sender.id,t}isSender(){let e=u.Z.getCurrentUser();return this.sender.equals(e)}constructor(){}}class T{get contacts(){return this._contacts}set contacts(e){this._contacts=e}get quns(){return this._quns}set quns(e){this._quns=e}}class S{static async getVisitorToken(){let e;return await l.Z.get("/chat/v2/get-visitor-token.json",!1).then(async t=>{e=t.data,sessionStorage.setItem(i.B1,t.data)}),e}static async getMessages(e){let t=[];return console.log("sessionKey getMessages",e),await l.Z.post("/chat/v2/messages.json",e).then(async e=>{let s=e.data;for(let e of(null==s&&(s=[]),s))t.push(d.fromMessage(e))}),t}static async getSessions(){let e=[];return await l.Z.get("/chat/v2/sessions.json").then(async t=>{for(let s of t.data)e.push(h.Z.createSession(s.chatType,s.id))}),e}static async getContacts(){let e=new T;return await l.Z.get("/contact/contacts.json").then(async t=>{t.data&&(e=t.data)}),e}}var y=s(32384),_=s(17892);class p{get version(){return this._version}set version(e){this._version=e}get messageType(){return this._messageType}set messageType(e){this._messageType=e}get chatType(){return this._chatType}set chatType(e){this._chatType=e}get sender(){return this._sender}set sender(e){this._sender=e}get receiver(){return this._receiver}set receiver(e){this._receiver=e}get chatSession(){return this._chatSession}set chatSession(e){this._chatSession=e}get content(){return this._content}set content(e){this._content=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}static fromBytes(e){let t=new p,s=new DataView(e),n=0;t.version=s.getUint8(n);let r=s.getUint8(n+1);t.chatType=r;let i=s.getUint8(n+2);t.messageType=i;let o=u.Z.fromBytes(s,n+3);if(t.sender=o.chatUser,n=o.offset,r===_.Z.CHAT_TYPE_1_TO_1){let e=u.Z.fromBytes(s,n),r=e.chatUser;t.receiver=r,n=e.offset,t.chatSession=h.Z.create121Session(t.sender,t.receiver)}else{let r=s.getUint8(n);n+=1;let i=new Uint8Array(e.slice(n,n+r)).toString();t.chatSession=h.Z.createGroupSession(i)}let a=s.getUint32(n);n+=4,t.content=new Uint8Array(e.slice(n,n+a)),n+=a;let c=new TextDecoder().decode(new Uint8Array(e.slice(n,e.byteLength)));return t.clientSendTime=parseInt(c,10),t}static create121Chat(e,t,s,n){let r=new p,i=u.Z.getCurrentUser();return r.version=1,r.chatType=_.Z.CHAT_TYPE_1_TO_1,r.messageType=e,r.sender=i,r.receiver=t,r.chatSession=h.Z.create121Session(r.sender,t),r.content=y.Z.str2Buffer(s),r.clientSendTime=n,r}toBytes(){return this.chatType===_.Z.CHAT_TYPE_1_TO_1?this.to121Bytes():this.toGroupBytes()}to121Bytes(){let e=this.sender.toBytes(),t=this.receiver.toBytes(),s=y.Z.str2Buffer(this.clientSendTime+""),n=3+e.byteLength+t.byteLength+4+this.content.byteLength+s.byteLength,r=0,i=new Uint8Array(n);return r=y.Z.appendBytes(i,new Uint8Array([this._version,this.chatType,this.messageType]),r),r=y.Z.appendBytes(i,e,r),r=y.Z.appendBytes(i,t,r),r=y.Z.appendBytes(i,y.Z.number2Buffer(this.content.byteLength),r),r=y.Z.appendBytes(i,this.content,r),y.Z.appendBytes(i,s,r),i}toGroupBytes(){let e=0,t=this.sender.toBytes(),s=this.chatSession.toBytes(),n=y.Z.str2Buffer(this.clientSendTime+""),r=new Uint8Array(3+t.byteLength+1+s.byteLength+4+this.content.byteLength+n.byteLength);return e=y.Z.appendBytes(r,new Uint8Array([this._version,this.chatType,this.messageType]),e),e=y.Z.appendBytes(r,t,e),e=y.Z.appendBytes(r,new Uint8Array([s.byteLength]),e),e=y.Z.appendBytes(r,s,e),e=y.Z.appendBytes(r,y.Z.number2Buffer(this.content.byteLength),e),e=y.Z.appendBytes(r,this.content,e),y.Z.appendBytes(r,n,e),r}getStringContent(){return new TextDecoder().decode(this.content)}constructor(){}}class f{reconnectWebSocket(){this.close(),this.stopHeartBeat(),this.stopRetryConnect(),this.reconnectionTimer=setInterval(()=>{if(f.activeStatus===f.INACTIVE_STATUS){console.log("窗口失去焦点，不进行重连");return}if(f.heartStatus===f.ACTIVE_STATUS){console.log("心跳正常，不进行重连");return}if(f.connectionStatus===f.CONNECTING_STATUS){console.log("正在连接中，不进行重连");return}if(f.connectionStatus===f.ACTIVE_STATUS){console.log("连接正常，不进行重连");return}this.connect()},this.reconnectTime)}connect(){try{f.connectionStatus=f.CONNECTING_STATUS,"WebSocket"in window&&(this.initWindowsFocusEvent(),this.ws=new WebSocket(this.url,[this.token]),this.onOpen(),this._onMsg(),this.onClose(),this.onError())}catch(e){f.connectionStatus=f.INACTIVE_STATUS,console.log("链接失败，直接重连",e),this.reconnectWebSocket()}}onOpen(){this.ws.onopen=e=>{console.log("连接成功"+e),this.connectionTimestamp=new Date().getTime(),f.connectionStatus=f.ACTIVE_STATUS,this.startHeartBeat()}}onClose(){this.ws.onclose=e=>{e.wasClean,f.connectionStatus=f.INACTIVE_STATUS,console.log("连接关闭,e.wasClean="+e.wasClean)}}onError(){this.ws.onerror=e=>{console.log("连接出错"),f.connectionStatus=f.INACTIVE_STATUS,this.reconnectWebSocket()}}startHeartBeat(){this.stopRetryConnect(),this.stopHeartBeat(),this.lastHeartTime=new Date().getTime(),this.heartTimer=setInterval(()=>{var e=new Date().getTime()-this.lastHeartTime;if(e>this.heartTimeout){console.log("超时重连 heart diff {}",e),this.stopHeartBeat(),this.reconnectWebSocket();return}try{if(this.ws.send("PING"),new Date().getTime()-this.lastStatusMonitoredTime>this.monitorTime){let e=this.monitorStatus();e.length>0?this.ws.send("STATUS|"+JSON.stringify(e)):this.ws.send("STATUS")}}catch(e){console.log("heart beat error:"+e)}},this.heartTime)}stopHeartBeat(){clearTimeout(this.heartTimer),f.heartStatus=f.INACTIVE_STATUS}stopRetryConnect(){clearTimeout(this.reconnectionTimer)}increaseTxid(){return this.txid=this.txid+1,this.txid}sendMessage(e){this.increaseTxid(),this.ws.send(e)}reconnectionCallback(){console.log("重连回调")}close(){if(null==this.ws){console.log("websocket is null");return}this.ws.close()}initWindowsFocusEvent(){window.onfocus=function(){console.log("window.onfocus"),f.activeStatus=f.ACTIVE_STATUS},window.onclick=function(){console.log("window.onclick"),f.activeStatus=f.ACTIVE_STATUS},window.onblur=function(){console.log("window.onblur"),f.activeStatus=f.INACTIVE_STATUS}}_onMsg(){this.ws.onmessage=async e=>{if("string"==typeof e.data){if("PONG"===e.data){this.lastHeartTime=new Date().getTime(),f.heartStatus=f.ACTIVE_STATUS;return}if("OFFLINE"===e.data){this.offlineCallback&&this.offlineCallback({offline:!0});return}var t=JSON.parse(e.data);if("STATUS"==t.instruction){let e=t.data;this.monitorStatusCallback&&this.monitorStatusCallback(e),this.lastStatusMonitoredTime=new Date().getTime();return}"AUTH"==t.instruction&&this.userAuthCallback&&this.userAuthCallback(t);return}let s=await e.data.arrayBuffer();this.increaseTxid(),this.onMsgCallback&&this.onMsgCallback(s)}}constructor(e,t){this.txid=0,this.heartTime=1e3,this.heartTimeout=5e3,this.reconnectTime=1e3,this.lastHeartTime=0,this.monitorTime=1e4,this.lastStatusMonitoredTime=0,this.url=e,this.token=t}}f.ACTIVE_STATUS="active",f.INACTIVE_STATUS="inactive",f.CONNECTING_STATUS="connecting",f.activeStatus=f.INACTIVE_STATUS,f.heartStatus=f.INACTIVE_STATUS,f.connectionStatus=f.INACTIVE_STATUS;var m=s(94962);class w{get webSocket(){return this._webSocket}closeWebSocket(){this._webSocket.close()}putMessage(e){let t=d.fromProtocol(e),s=e.chatSession.key(),n=this.messageMap.get(s);null==n&&(n=[],this.messageMap.set(s,n)),n.push(t)}sendMessage(e,t){var s;let n;let r=h.Z.parse(e);if((null==r?void 0:r.chatType)==_.Z.CHAT_TYPE_1_TO_1){let e=r.getOppositeUser();n=p.create121Chat(_.Z.TEXT_MESSAGE,e,t,new Date().getTime())}this.putMessage(n),null===(s=this._webSocket)||void 0===s||s.sendMessage(n.toBytes())}async getMessageList(e){console.log("getMessageList",e);let t=this.messageMap.get(e);return null!=t||(t=await S.getMessages(e),this.messageMap.set(e,t)),t}websocketMsgCallback(e){let t=p.fromBytes(e);this.putMessage(t),this.newMessageSignal()}async getChatSessions(){let e=this.chatSessions;return e||await S.getSessions().then(t=>{console.log(t.length),e=t,this.chatSessions=e}),e}async getContactGroup(){let e=this.contactGroup;return e||await S.getContacts().then(t=>{console.log(t),e=t,this.contactGroup=e}),e}getGroupDetail(e){var t;return null===(t=this.contactGroup)||void 0===t?void 0:t.quns.find(t=>t.qunId===e)}getContactDetail(e){var t;return null===(t=this.contactGroup)||void 0===t?void 0:t.contacts.find(t=>t.userId===e)}constructor(e){this.messageMap=new Map,this.chatSessions=null,this.contactGroup=null,this.newMessageSignal=()=>{};let t=new f(i.Yo,e);t.connect(),this._webSocket=t,this._webSocket.onMsgCallback=e=>{this.websocketMsgCallback(e)},this._webSocket.offlineCallback=()=>{m.ZP.error("消息已推送，对方已离线....")},this._webSocket.userAuthCallback=e=>{console.log("userValidCallback",JSON.stringify(e)),"0"==e.code?sessionStorage.setItem(i.Ee,JSON.stringify(e.data)):((0,a.gy)(),m.ZP.error(e.message))},this._webSocket.monitorStatus=()=>(console.log("websocket monitor status"),[]),this._webSocket.monitorStatusCallback=e=>{console.log("websocket monitor status callback",JSON.stringify(e))}}}function v(e){let{children:t}=e,[s,l]=(0,o.useState)();return(console.log("渲染ChatLayout"),(0,o.useEffect)(()=>((async function(){let e=new w(await (0,a.LP)(()=>S.getVisitorToken())),t=c.t.create(e);e.newMessageSignal=()=>{l(null==t?void 0:t.newReference())},l(t)})(),()=>{null==s||s.closeWebSocket()}),[]),s)?(console.log("状态变化会重新渲染",s),(0,n.jsxs)("div",{className:"flex flex-row flex-1 w-full",children:[(0,n.jsxs)("div",{className:"w-[20rem] flex flex-col  gap-4 p-4 border-r border-indigo-500",children:[(0,n.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,n.jsx)(r.default,{href:"".concat(i.Y4,"/chat/friends"),children:"通讯录管理"})}),(0,n.jsx)("div",{className:"bg-cyan-500 text-white p-2 rounded-xl cursor-pointer",children:(0,n.jsx)(r.default,{href:"".concat(i.Y4,"/chat/sessions/session"),children:"我的会话"})})]}),(0,n.jsx)("div",{className:"flex-1 border-l border-indigo-500",children:(0,n.jsx)(c.D.Provider,{value:s,children:t})})]})):(0,n.jsx)("div",{children:"init context ...."})}},78411:function(e,t,s){"use strict";s.d(t,{D:function(){return i},t:function(){return r}});var n=s(2265);class r{static create(e){return new r(e)}newReference(){return new r(this.messageBroker)}closeWebSocket(){var e;null===(e=this.messageBroker)||void 0===e||e.closeWebSocket()}constructor(e){this.messageBroker=e}}let i=(0,n.createContext)(null)},17892:function(e,t,s){"use strict";s.d(t,{Z:function(){return n}});class n{}n.TEXT_MESSAGE=0,n.IMAGE_MESSAGE=1,n.CHAT_TYPE_1_TO_1=0,n.CHAT_TYPE_GROUP=1,n.HORIZON_LINE="-"},21292:function(e,t,s){"use strict";s.d(t,{Z:function(){return i}});var n=s(17892),r=s(8713);class i{get chatType(){return this._chatType}set chatType(e){this._chatType=e}get id(){return this._id}set id(e){this._id=e}static create121Session(e,t){let s=new i;return s.chatType=n.Z.CHAT_TYPE_1_TO_1,s.id=s.generateKey(e,t),s}static createSession(e,t){let s=new i;return s.chatType=e,s.id=t,s}static parse(e){if(null==e)return null;let t=new i,s=parseInt(e.substring(0,1),10),n=e.substring(1);return t._chatType=s,t.id=n,t}static createGroupSession(e){let t=new i;return t.chatType=n.Z.CHAT_TYPE_GROUP,t.id=e,t}isGroup(){return this._chatType==n.Z.CHAT_TYPE_GROUP}isOne2One(){return this._chatType==n.Z.CHAT_TYPE_1_TO_1}getOppositeUser(){let e=r.Z.getCurrentUser();if(null==e||this._chatType===n.Z.CHAT_TYPE_GROUP)return null;let t=this.id.substring(0,1),s=this.id.substring(1,2),i=parseInt(this.id.substring(2,4),10),o=this.id.substring(4,4+i),a=this.id.substring(4+i),c=new r.Z(o,parseInt(t,10)),l=new r.Z(a,parseInt(s,10));return c.equals(e)?l:c}toBytes(){return new TextEncoder().encode(this._chatType+this.id)}key(){return this.chatType+this.id}generateKey(e,t){if(null==e||null==t)return"";let s=e,n=t;e.id<=t.id&&(s=t,n=e);let r=(s.id+"").length,i=r+"";return r<10&&(i="0"+r),s.category+""+n.category+i+s.id+n.id}}},8713:function(e,t,s){"use strict";s.d(t,{Z:function(){return i}});var n=s(32384),r=s(95189);class i{get id(){return this._id}get category(){return this._category}static fromBytes(e,t){let s=e.buffer,n=e.getUint8(t);t+=1;let r=new Uint8Array(s.slice(t,t+n));return t+=n,{chatUser:new i(new TextDecoder().decode(r),e.getUint8(t)),offset:t+1}}static parse(e){let t=e.split("_");return 2!=t.length?null:new i(t[0],Number(t[1]))}static getCurrentUser(){let e=sessionStorage.getItem(r.Ee);if(!e)return null;let t=JSON.parse(e);return new i(t.userId,t.category)}getCategoryName(){return this._category==i.CATEGORY_VISITOR?"访客":this._category==i.CATEGORY_REGISTER?"注册用户":"未知"}key(){return this._id+"_"+this._category}equals(e){return null!=e&&this._id==e.id&&this._category==e.category}toBytes(){let e=n.Z.str2Buffer(this._id+""),t=new Uint8Array([this._category]),s=new Uint8Array(1+e.byteLength+1),r=e.byteLength,i=0;return i=n.Z.appendBytes(s,new Uint8Array([r]),i),i=n.Z.appendBytes(s,e,i),n.Z.appendBytes(s,t,i),s}constructor(e,t){this._id=e,this._category=t}}i.CATEGORY_VISITOR=0,i.CATEGORY_REGISTER=1}},function(e){e.O(0,[231,4962,8729,2971,7023,1744],function(){return e(e.s=84576)}),_N_E=e.O()}]);