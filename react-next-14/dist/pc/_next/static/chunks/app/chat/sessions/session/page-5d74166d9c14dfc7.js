(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8426],{91769:function(e,t,n){Promise.resolve().then(n.bind(n,66846))},66846:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return _}});var s=n(57437),r=n(2265),i=n(16463);function o(e){let t="left"===e.align?"items-start":"items-end";return(0,s.jsxs)("div",{className:"flex flex-col ".concat(t),children:[(0,s.jsxs)("div",{className:"flex flex-row  p-4 bg-gray-100 rounded-lg",children:[(0,s.jsx)("img",{className:" w-8 h-8 rounded-full mr-4",src:"/columns/1.jpg"}),(0,s.jsxs)("strong",{className:"flex-1 text-gray-900",children:["sender: ",e.sender," @",e.timestamp]})]}),(0,s.jsxs)("p",{className:"text-gray-600",children:[e.message,e.img&&(0,s.jsx)("img",{className:"w-64",src:e.img})]})]})}var a=n(8713),c=n(21292),l=n(51447),u=n(17892);class h{get version(){return this._version}set version(e){this._version=e}get messageType(){return this._messageType}set messageType(e){this._messageType=e}get chatType(){return this._chatType}set chatType(e){this._chatType=e}get sender(){return this._sender}set sender(e){this._sender=e}get receiver(){return this._receiver}set receiver(e){this._receiver=e}get chatSession(){return this._chatSession}set chatSession(e){this._chatSession=e}get content(){return this._content}set content(e){this._content=e}get clientSendTime(){return this._clientSendTime}set clientSendTime(e){this._clientSendTime=e}get serverTime(){return this._serverTime}set serverTime(e){this._serverTime=e}static fromBytes(e){let t=new h,n=new DataView(e),s=0;t.version=n.getUint8(s);let r=n.getUint8(s+1);t.chatType=r;let i=n.getUint8(s+2);t.messageType=i;let o=a.Z.fromBytes(n,s+3);if(t.sender=o.chatUser,s=o.offset,r===u.Z.CHAT_TYPE_1_TO_1){let e=a.Z.fromBytes(n,s),r=e.chatUser;t.receiver=r,s=e.offset}else{let r=n.getUint8(s);s+=1;let i=new Uint8Array(e.slice(s,s+r)).toString();t.chatSession=c.Z.createGroupSession(i)}let l=n.getUint32(s);s+=4,t.content=new Uint8Array(e.slice(s,s+l)),s+=l;let g=new TextDecoder().decode(new Uint8Array(e.slice(s,e.byteLength)));return t.clientSendTime=parseInt(g,10),t}static create121Chat(e,t,n,s){let r=new h,i=a.Z.getCurrentUser();return r.version=1,r.chatType=u.Z.CHAT_TYPE_1_TO_1,r.messageType=e,r.sender=i,r.receiver=t,r.chatSession=c.Z.create121Session(r.sender,t),r.content=l.Z.str2Buffer(n),r.clientSendTime=s,r}toBytes(){return this.chatType===u.Z.CHAT_TYPE_1_TO_1?this.to121Bytes():this.toGroupBytes()}to121Bytes(){let e=this.sender.toBytes(),t=this.receiver.toBytes(),n=l.Z.str2Buffer(this.clientSendTime+""),s=3+e.byteLength+t.byteLength+4+this.content.byteLength+n.byteLength,r=0,i=new Uint8Array(s);return r=l.Z.appendBytes(i,new Uint8Array([this._version,this.chatType,this.messageType]),r),r=l.Z.appendBytes(i,e,r),r=l.Z.appendBytes(i,t,r),r=l.Z.appendBytes(i,l.Z.number2Buffer(this.content.byteLength),r),r=l.Z.appendBytes(i,this.content,r),l.Z.appendBytes(i,n,r),i}toGroupBytes(){let e=0,t=this.sender.toBytes(),n=this.chatSession.toBytes(),s=l.Z.str2Buffer(this.clientSendTime+""),r=new Uint8Array(3+t.byteLength+1+n.byteLength+4+this.content.byteLength+s.byteLength);return e=l.Z.appendBytes(r,new Uint8Array([this._version,this.chatType,this.messageType]),e),e=l.Z.appendBytes(r,t,e),e=l.Z.appendBytes(r,new Uint8Array([n.byteLength]),e),e=l.Z.appendBytes(r,n,e),e=l.Z.appendBytes(r,l.Z.number2Buffer(this.content.byteLength),e),e=l.Z.appendBytes(r,this.content,e),l.Z.appendBytes(r,s,e),r}getStringContent(){return new TextDecoder().decode(this.content)}isSender(){let e=a.Z.getCurrentUser();return this.sender.equals(e)}align(){return this.isSender()?"right":"left"}constructor(){}}class g{reconnectWebSocket(){this.close(),this.stopHeartBeat(),this.stopRetryConnect(),this.reconnectionTimer=setInterval(()=>{if(g.activeStatus===g.INACTIVE_STATUS){console.log("窗口失去焦点，不进行重连");return}if(g.heartStatus===g.ACTIVE_STATUS){console.log("心跳正常，不进行重连");return}if(g.connectionStatus===g.CONNECTING_STATUS){console.log("正在连接中，不进行重连");return}if(g.connectionStatus===g.ACTIVE_STATUS){console.log("连接正常，不进行重连");return}this.connect()},this.reconnectTime)}connect(){try{g.connectionStatus=g.CONNECTING_STATUS,"WebSocket"in window&&(this.ws=new WebSocket(this.url,[this.token]),this.initWindowsFocusEvent(),this.onOpen(),this._onMsg(),this.onClose(),this.onError())}catch(e){console.log("链接失败，直接重连",e),this.reconnectWebSocket()}}onOpen(){this.ws.onopen=e=>{console.log("连接成功"+e),this.connectionTimestamp=new Date().getTime(),g.connectionStatus=g.ACTIVE_STATUS,this.startHeartBeat()}}onClose(){this.ws.onclose=e=>{e.wasClean,g.connectionStatus=g.INACTIVE_STATUS,console.log("连接关闭,e.wasClean="+e.wasClean)}}onError(){this.ws.onerror=e=>{console.log("连接出错"),g.connectionStatus=g.INACTIVE_STATUS,this.reconnectWebSocket()}}startHeartBeat(){this.stopRetryConnect(),this.stopHeartBeat(),this.lastHeartTime=new Date().getTime(),this.heartTimer=setInterval(()=>{var e=new Date().getTime()-this.lastHeartTime;if(e>this.heartTimeout){console.log("超时重连 heart diff {}",e),this.stopHeartBeat(),this.reconnectWebSocket();return}try{this.ws.send("PING")}catch(e){console.log("heart beat error:"+e)}},this.heartTime)}stopHeartBeat(){clearTimeout(this.heartTimer),g.heartStatus=g.INACTIVE_STATUS}stopRetryConnect(){clearTimeout(this.reconnectionTimer)}sendMessage(e){this.ws.send(e.toBytes())}reconnectionCallback(){console.log("重连回调")}close(){this.ws.close()}initWindowsFocusEvent(){window.onfocus=function(){console.log("window.onfocus"),g.activeStatus=g.ACTIVE_STATUS},window.onclick=function(){console.log("window.onclick"),g.activeStatus=g.ACTIVE_STATUS},window.onblur=function(){console.log("window.onblur"),g.activeStatus=g.INACTIVE_STATUS}}_onMsg(){this.ws.onmessage=async e=>{if("string"==typeof e.data){if("PONG"===e.data){this.lastHeartTime=new Date().getTime(),g.heartStatus=g.ACTIVE_STATUS;return}if("OFFLINE"===e.data){this.offlineCallback({offline:!0});return}var t=JSON.parse(e.data);this.userValidCallback(t);return}let n=await e.data.arrayBuffer();this.onMsgCallback(h.fromBytes(n))}}constructor(e,t){this.heartTime=1e3,this.heartTimeout=5e3,this.reconnectTime=1e3,this.lastHeartTime=0,this.url=e,this.token=t}}g.ACTIVE_STATUS="active",g.INACTIVE_STATUS="inactive",g.CONNECTING_STATUS="connecting",g.activeStatus=g.INACTIVE_STATUS,g.heartStatus=g.INACTIVE_STATUS,g.connectionStatus=g.INACTIVE_STATUS;var d=n(59846);class T{get align(){return this._align}get messageId(){return this._messageId}get senderName(){return this._senderName}get senderCategory(){return this._senderCategory}get receiverName(){return this._receiverName}get receiverCategory(){return this._receiverCategory}get content(){return this._content}get sendTime(){return this._sendTime}constructor(e){this._messageId=e.clientSendTime+Math.random(),this._align=e.align(),this._senderName=e.sender.getId(),this._senderCategory=e.sender.getCategoryName(),this._receiverName=e.receiver.getId(),this._receiverCategory=e.receiver.getCategoryName(),this._content=e.getStringContent();let t=new Date(e.clientSendTime);this._sendTime=(0,d.WU)(t,"yyyy-MM-dd")}}var y=n(94962),f=n(83480),m=n(49753);function p(){let e=(0,i.useSearchParams)(),t=null==e?void 0:e.get("sessionKey"),[n,a]=(0,r.useState)(),[l,d]=(0,r.useState)(""),[p,_]=(0,r.useState)([]),S=(0,r.useRef)(null);function w(e){_(t=>[...t,new T(e)])}function C(){let e;let s=c.Z.parse(t);if(console.log("containerRef",S.current),(null==s?void 0:s.chatType)==u.Z.CHAT_TYPE_1_TO_1){let t=s.getOppositeUser();e=h.create121Chat(u.Z.TEXT_MESSAGE,t,l,new Date().getTime())}w(e),null==n||n.sendMessage(e),d("")}return(0,r.useEffect)(()=>((async function(){let e=new g("ws://localhost:8080/websocket",await (0,f.LP)(!0));e.userValidCallback=e=>{console.log("userValidCallback",JSON.stringify(e)),"0"==e.code?sessionStorage.setItem(m.Ee,JSON.stringify(e.data)):((0,f.gy)(),y.ZP.error(e.message))},e.connect(),e.onMsgCallback=e=>{w(e)},a(e)})(),()=>{null==n||n.close()}),[]),(0,r.useEffect)(()=>{var e;null===(e=S.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end"})},[p]),(0,s.jsxs)("div",{className:"flex flex-col w-full h-full",children:[(0,s.jsx)("div",{children:(0,s.jsxs)("h2",{children:["Welcome to: ",t]})}),(0,s.jsxs)("div",{className:"overflow-y-scroll h-[25rem] p-4 border-2 border-red-700",children:[p.map(e=>(0,s.jsx)(o,{img:void 0,align:e.align,message:e.content,sender:e.senderName,timestamp:e.sendTime},e.messageId)),(0,s.jsx)("div",{className:"h-[0px] h-[0px]",ref:S})]}),(0,s.jsx)("textarea",{value:l,onKeyDown:e=>{"Enter"===e.code&&C()},onChange:e=>d(e.target.value),className:"w-full flex-1"}),(0,s.jsx)("button",{onClick:e=>C(),className:"bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",children:"Send"})]})}function _(){return(0,s.jsx)(r.Suspense,{children:(0,s.jsx)(p,{})})}},49753:function(e,t,n){"use strict";n.d(t,{B1:function(){return o},Ee:function(){return s},Y4:function(){return c},_k:function(){return a},lg:function(){return r},oT:function(){return i}});let s="user_info",r="http://localhost:7890/",i="LOCAL",o="sparrow-token",a="SESSION",c="http://www.sparrowzoo.com/react"},88161:function(e,t,n){"use strict";n.d(t,{H:function(){return o}});var s=n(83480),r=n(49753),i=n(94962);class o{static async get(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];e=r.lg+e;let n=null;return t&&(n=await (0,s.LP)(!1).then(e=>e)),new Promise((t,s)=>{fetch(e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:n}}).then(async e=>{let n=await e.json();"0"!=n.code?(i.ZP.error(null==n?void 0:n.message),s(n)):t(n)}).catch(e=>{i.ZP.error(e.message),s(e)})})}static async post(e,t){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2];e=r.lg+e;let o=null;return n&&(o=await (0,s.LP)(!1).then(e=>e)),new Promise((n,s)=>{fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o},body:t}).then(async e=>{let t=await e.json();"0"!=t.code?(i.ZP.error(null==t?void 0:t.message),s(t)):n(t)}).catch(e=>{i.ZP.error(e.message),s(e)})})}}},83480:function(e,t,n){"use strict";n.d(t,{LP:function(){return a},gy:function(){return o},o4:function(){return c}});var s=n(49753),r=n(94962),i=n(88161);function o(){sessionStorage.removeItem(s.B1),localStorage.removeItem(s.B1),sessionStorage.removeItem(s.Ee)}async function a(e){null==e&&(e=!1);let t=sessionStorage.getItem(s.B1);return t||(t=localStorage.getItem(s.B1))?t:e?(await i.H.get("/chat/v2/get-visitor-token.json",!1).then(async e=>{"0"==e.code?(t=e.data,sessionStorage.setItem(s.B1,e.data)):r.ZP.error(e.message)}).catch(e=>{r.ZP.error(e.message),console.error(e)}),t):""}function c(e){if(s.oT==s._k){sessionStorage.setItem(s.B1,e);return}localStorage.setItem(s.B1,e)}},51447:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});class s{static bytes2ArrayBuffer(e){let t=new Uint8Array(e.length);for(let n=0;n<t.length;n++)t[n]=e[n];return t}static str2Buffer(e){if("undefined"==typeof TextEncoder){let t,n=[];for(let s=0;s<e.length;s++)(t=e.charCodeAt(s))>=65536&&t<=1114111?(n.push(t>>18&7|240),n.push(t>>12&63|128),n.push(t>>6&63|128),n.push(63&t|128)):t>=2048&&t<=65535?(n.push(t>>12&15|224),n.push(t>>6&63|128),n.push(63&t|128)):t>=128&&t<=2047?(n.push(t>>6&31|192),n.push(63&t|128)):n.push(255&t);return s.bytes2ArrayBuffer(n)}return new TextEncoder().encode(e)}static number2Buffer(e){var t=[],n=length=4;do t[--n]=255&e,e>>=8;while(n);return s.bytes2ArrayBuffer(t)}static appendBytes(e,t,n){return e.set(t,n),n+t.byteLength}readString(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r="",i=s?2:1;for(let o=0;o<n;o+=i)r+=String.fromCharCode(s?e.getUint16(t+o,!0):e.getUint8(t+o));return r}}},17892:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});class s{}s.TEXT_MESSAGE=0,s.IMAGE_MESSAGE=1,s.CHAT_TYPE_1_TO_1=0,s.CHAT_TYPE_GROUP=1,s.HORIZON_LINE="-"},21292:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var s=n(17892),r=n(8713);class i{get chatType(){return this._chatType}set chatType(e){this._chatType=e}get id(){return this._id}set id(e){this._id=e}static create121Session(e,t){let n=new i;return n.chatType=s.Z.CHAT_TYPE_1_TO_1,n.id=n.generateKey(e,t),n}static parse(e){if(null==e)return null;let t=new i,n=parseInt(e.substring(0,1),10),s=e.substring(1);return t._chatType=n,t.id=s,t}static createGroupSession(e){let t=new i;return t.chatType=s.Z.CHAT_TYPE_GROUP,t.id=e,t}isGroup(){return this._chatType==s.Z.CHAT_TYPE_GROUP}isOne2One(){return this._chatType==s.Z.CHAT_TYPE_1_TO_1}getOppositeUser(){let e=r.Z.getCurrentUser();if(null==e||this._chatType===s.Z.CHAT_TYPE_GROUP)return null;let t=this._id.split(s.Z.HORIZON_LINE);if(2!=t.length)return null;let n=r.Z.parse(t[0]),i=r.Z.parse(t[1]);return e.equals(n)?i:e.equals(i)?n:null}toBytes(){return new TextEncoder().encode(this._chatType+this.id)}generateKey(e,t){return null==e||null==t?"":e.getId()<=t.getId()?e.key+"-"+t:t.key()+"-"+e.key()}}},8713:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var s=n(51447),r=n(49753);class i{static fromBytes(e,t){let n=e.buffer,s=e.getUint8(t);t+=1;let r=new Uint8Array(n.slice(t,t+s));return t+=s,{chatUser:new i(new TextDecoder().decode(r),e.getUint8(t)),offset:t+1}}static parse(e){let t=e.split("_");return 2!=t.length?null:new i(t[0],Number(t[1]))}static getCurrentUser(){let e=sessionStorage.getItem(r.Ee);if(!e)return null;let t=JSON.parse(e);return new i(t.userId,t.category)}getId(){return this.id}getCategory(){return this.category}getCategoryName(){return this.category==i.CATEGORY_VISITOR?"访客":this.category==i.CATEGORY_REGISTER?"注册用户":"未知"}key(){return this.id+"_"+this.category}equals(e){return null!=e&&this.id==e.getId()&&this.category==e.getCategory()}toBytes(){let e=s.Z.str2Buffer(this.id+""),t=new Uint8Array([this.category]),n=new Uint8Array(1+e.byteLength+1),r=e.byteLength,i=0;return i=s.Z.appendBytes(n,new Uint8Array([r]),i),i=s.Z.appendBytes(n,e,i),s.Z.appendBytes(n,t,i),n}constructor(e,t){this.id=e,this.category=t}}i.CATEGORY_VISITOR=0,i.CATEGORY_REGISTER=1}},function(e){e.O(0,[4962,8241,2971,7023,1744],function(){return e(e.s=91769)}),_N_E=e.O()}]);